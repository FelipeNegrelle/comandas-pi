<!DOCTYPE html>
<html lang="pt"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
  <title>Cadastrar Comanda</title>
</head>
<body>
<section layout:fragment="corpo">

  <div class="container mt-4">

    <!-- Nome do cliente responsável -->
    <h2 th:text="'Comanda de: ' + (${comanda.responsavel != null ? comanda.responsavel.nome : 'Selecione um cliente'})">
      Comanda
    </h2>


    <!-- Form principal -->
    <form th:action="@{/comandas/salvar}" th:object="${comanda}" method="post">

      <select th:field="*{responsavel}" class="form-select">
        <option th:each="c : ${clientes}"
                th:value="${c.id}"
                th:text="${c.nome}">
        </option>
      </select>

      <!-- Tabela de itens -->
      <table class="table table-bordered mt-3" id="tabela-itens">
        <thead>
        <tr>
          <th>Data</th>
          <th>Quantidade</th>
          <th>Item</th>
          <th>Valor Unitário</th>
          <th>Total Parcial</th>
          <th>Nome Consumidor</th>
          <th>Ações</th>
        </tr>
        </thead>
      <tbody id="itens-container">
        <tr>
          <td><input type="date" name="itens[0].data" class="form-control"/></td>
          <td><input type="number" min="1" name="itens[0].quantidade" class="form-control"/></td>
          <td>
            <select name="itens[0].itemSelecionado" class="form-select">
              <option value="">-- Selecione --</option>
              <option th:each="i : ${itens}"
                      th:value="${i.tipo + '-' + i.id}"
                      th:text="${i.tipo + ': ' + i.nome}">
              </option>
            </select>
          </td>
          <td><input type="number" step="0.01" name="itens[0].valor" class="form-control"/></td>
          <td><span class="total-parcial">0</span></td>
          <td><input type="text" name="itens[0].requerente" class="form-control"/></td>
          <td><button type="button" class="btn btn-danger btn-sm remover-item">X</button></td>
        </tr>
      </tbody>

      </table>

      <!-- Botão para adicionar nova linha -->
      <button type="button" class="btn btn-success mt-2" id="adicionar-item">+ Adicionar Item</button>

      <!-- Botão salvar -->
      <div class="mt-3">
        <button type="submit" class="btn btn-primary">Salvar Comanda</button>
      </div>


    </form>

  </div>

</section>
<th:block layout:fragment="scripts">
  <script>
    document.addEventListener("DOMContentLoaded", function() {

      const addItemButton = document.getElementById("adicionar-item");
      const itensContainer = document.getElementById("itens-container");

      if (addItemButton && itensContainer) {
        addItemButton.addEventListener("click", function() {

          const index = itensContainer.children.length;
          const novaLinha = document.createElement("tr");
          novaLinha.innerHTML = `
              <td><input type="date" name="itens[${index}].data" class="form-control"/></td>
              <td><input type="number" min="1" name="itens[${index}].quantidade" class="form-control" value="1"/></td>
              <td>
                  <select name="itens[${index}].itemSelecionado" class="form-select">
                      <option value="">-- Selecione --</option>
                      ${
                          Array.from(document.querySelectorAll('select[name="itens[0].itemSelecionado"] option'))
                              .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
                              .join('')
                      }
                  </select>
              </td>
              <td><input type="number" step="0.01" name="itens[${index}].valor" class="form-control"/></td>
              <td><span>0</span></td>
              <td><input type="text" name="itens[${index}].requerente" class="form-control"/></td>
          `;
          itensContainer.appendChild(novaLinha);
        });
      }
    });
  </script>
</th:block>



</body>
</html>
